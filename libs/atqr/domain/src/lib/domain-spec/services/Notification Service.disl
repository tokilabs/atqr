domain ATQR

  context Challenges

    service NotificationService
    depends on EmailService
    depends on ChallengeRepository

    sendEmail template: EmailTemplate data: Object, to: EmailAddress
      {{using}} Pug
        parse template.subject with data as :subject
        parse template.body with data as :body
      create new Email ^to with :subject and :body
      send ${it} {{using}} IEmailService

    -> EmailSent! notification: Notification
      if email.requiresUserAction
        if ^notification's messagesSent equals Settings.maxRetries
          email.nextContactDate = null

        else
          let ^days be the result of:
            Settings.retryDelay for amount of ^notification's contactLogs

          email.nextContactDate = last ^notification's contactLog's sentAt + ^days

    ⏰ NewDayStarted!
      for each :notification in NotificationRepository
        where :notification's nextContactDate is Today or before Today
          sendEmail
            template: :notification.emailTemplate
            data: :notification.data
            to: :notification.email

          publish EmailSent! :notification
          // TODO: como enviar eventos especificos dependendo da Notificação?
          // Ex: OfficiationRequestSent! or PlayerAbandonedChallenge!

        // TODO: econtrar um jeito de definir o que fazer APÓS exceder as tentativas
        // caso de uso:
        //    if we've sent more than Settings.maxRetries emails
        //      sendEmail
        //        template: YourContenderNeverShowedUpEmail
        //        data: Challenge
        //        to: :challenge.owner.email
        //
        //      publish InviteeAbandonedTheChallenge! :challengeId :invitee

    //-------------------------------
    // Transactional Messages
    //-------------------------------

    -> ChallengeCreated! :challenge
      sendEmail
        params:
          template: ConfirmEmailToValidateChallenge
          data: Challenge
          to: :challenge.owner.email

      when :challenge.createdByPlayer

        for each [contact] in :challenge's invitees
          if it's role is Judge
            sendEmail
              template: RequestOfficiationEmail
              data: Challenge
              to: :contact.email

            📢 publish OfficiationRequested!

          if it's role is Player
            sendEmail
              template: YouHaveBeenChallengedEmail
              data: Challenge
              to: :contact.email

            📢 publish PlayerParticipationRequested!

    -> ChallengeGotANewInvitee! :challenge, invitee: Invitee
        if invitee's role is .Judge
          sendEmail OfficiationRequestEmail
            sendEmail
                template: RequestOfficiationEmail
                data:
                  challenge: ^challenge
                  invitee: ^invitee
                to: :contact.email

          📢 publish OfficiationRequested!

        if invitee's role is .Player
          sendEmail
            template: YouHaveBeenChallengedEmail
            data:
              challenge: ^challenge
              invitee: ^invitee
            to: :contact.email

          📢 publish PlayerParticipationRequested!

    //-------------------------------
    // Notification Messages
    //-------------------------------

    -> OfficiationRequestAccepted!
        sendEmail OfficiationRequestAccepted

    -> OfficiationRequestRejected!
        sendEmail JudgeRejectedEmail

    -> ChallengeAccepted! enrollment: Enrollment
        sendEmail
          params:
            template: ChallengeAcceptedEmail
            data: ^enrollment
            to: ^enrollment.judge.email

    -> ChallengeRejected!
        params:
          - challenge: Challenge

        sendEmail with:
          template: ChallengeRejectedEmail
          data: ^challenge
          to: ^challenge.owner.email

    -> ChallengeOngoing!
        sendEmail ChallengeOngoingEmailToPlayer

    -> ChallengeAccomplished! :challenge
        sendEmail with:
          template: ChallengeAccomplishedEmail
          to: :challenge.enrollments[0].player.email
          data: :challenge

    -> ChallengeFailed! :challenge
        sendEmail
          params:
            template: ChallengeFailedEmail
            to: :challenge.enrollments[0].player.email
            data: :challenge

    -> OfficiationRequestDenied!

    -> OfficiationRequestAccepted!
